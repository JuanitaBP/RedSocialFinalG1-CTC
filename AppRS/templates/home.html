{% extends "index.html" %}

<head>
  <!-- Agregar Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
  />

  <!-- Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    rel="stylesheet"
  />

  {% block "titulo" %}
  <title>Inicio</title>
  {% endblock "titulo" %}
</head>

{% block "content" %}
<a href="/publicacion/crear/">Nueva Publicación</a>

<h2>Publicaciones Recientes</h2>

<div class="posts-grid">
  {% for post in posts %}

  <div class="post-card">
    <div class="post-header">
      <p>Publicado por: {{ post.user.username }}</p>
      <em>{{ post.created|date:"d M Y H:i" }}</em>
    </div>

    <!-- Imagen de la publicación -->
    {% if post.imagen %}
    <img
      src="{{ post.imagen.url }}"
      alt="Imagen de {{ post.titulo }}"
      class="post-image"
    />
    {% endif %}

    <!-- Sección de acciones (Me gusta, Comentar, Guardar) -->
    <div class="post-actions">
      <i id="like-icon-{{ post.id }}" class="bi bi-heart"></i>
      <!-- Me gusta -->
      <i class="bi bi-chat"></i>
      <!-- Comentar -->
      <i class="bi bi-send"></i>
      <!-- Enviar -->

      <!-- Verificar si la publicación ya está guardada y mostrar el ícono adecuado -->
      {% if post in request.user.perfilusuario.posts_guardados.all %}
      <!-- Si la publicación está guardada, mostrar el ícono lleno -->
      <i
        id="save-icon-{{ post.id }}"
        class="bi bi-bookmark-fill"
        style="color: #8364a0"
      ></i>
      {% else %}
      <!-- Si la publicación no está guardada, mostrar el ícono vacío -->
      <i id="save-icon-{{ post.id }}" class="bi bi-bookmark"></i>
      {% endif %}
    </div>

    <!-- Resto del contenido de la publicación -->
    <div class="post-content">
      <h2>{{ post.titulo }}</h2>
      <p>{{ post.descripcion }}</p>
    </div>

    <div>
      <h2>Comentarios</h2>
      {% for comentario in comentarios %}
      <p>
        <strong>{{ comentario.usuario.username }}:</strong> {{
        comentario.contenido }}
      </p>
      {% empty %}
      <p>No hay comentarios aún.</p>
      {% endfor %}

      <form method="POST">
        {% csrf_token %} {{ comentario_form.as_p }}
        <button type="submit">Agregar comentario</button>
      </form>
    </div>
    <!-- Botones de editar y eliminar (solo para el propietario de la publicación) -->
    {% if post.user == request.user %}
    <div class="post-actions-buttons">
      <a href="{% url 'editarPublicacion' post.id %}" class="btn btn-warning"
        >Editar</a
      >
      <a href="{% url 'eliminarPublicacion' post.id %}" class="btn btn-danger"
        >Eliminar</a
      >
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

<!-- Script para manejar el guardado de publicaciones -->
<script>
  document.querySelectorAll("[id^=save-icon]").forEach((icon) => {
    icon.addEventListener("click", () => {
      let postId = icon.id.split("-")[2]; // Obtener el ID del post desde el ID del ícono

      fetch("{% url 'toggle_guardar_publicacion' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ post_id: postId }),
      })
        .then((response) => response.json())
        .then((data) => {
          // Alternar entre los estados del ícono según si la publicación fue guardada o no
          icon.classList.toggle("bi-bookmark-fill"); // Cambiar a marcador lleno
          icon.classList.toggle("bi-bookmark"); // Cambiar a marcador vacío
          icon.style.color = data.saved ? "#8364A0" : "black"; // Cambiar el color según el estado guardado
        })
        .catch((error) => console.error("Error:", error));
    });
  });

  //vista de likes por el momento es solo visual
  document.querySelectorAll("[id^=like-icon]").forEach((icon) => {
    icon.addEventListener("click", () => {
      icon.classList.toggle("bi-heart-fill"); // Cambiar a corazón lleno
      icon.classList.toggle("bi-heart"); // Cambiar a corazón vacío
      icon.style.color = icon.classList.contains("bi-heart-fill")
        ? "red"
        : "black"; // Cambiar color
    });
  });
</script>
{% endblock "content" %}
